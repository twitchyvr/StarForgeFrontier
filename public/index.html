<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>StarForge Frontier</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="A multiplayer spaceship building and space exploration game with full physics, upgrades and an engaging in‚Äëgame economy." />
  <meta name="theme-color" content="#0d1421" />
  <meta name="background-color" content="#0d1421" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="StarForge" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="application-name" content="StarForge" />
  <meta name="msapplication-TileColor" content="#0d1421" />
  <meta name="msapplication-tap-highlight" content="no" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  
  <!-- iOS Specific -->
  <link rel="apple-touch-icon" href="icons/icon-192x192.svg" />
  <link rel="apple-touch-icon" sizes="72x72" href="icons/icon-72x72.svg" />
  <link rel="apple-touch-icon" sizes="96x96" href="icons/icon-96x96.svg" />
  <link rel="apple-touch-icon" sizes="128x128" href="icons/icon-128x128.svg" />
  <link rel="apple-touch-icon" sizes="144x144" href="icons/icon-144x144.svg" />
  <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.svg" />
  <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192x192.svg" />
  <link rel="apple-touch-icon" sizes="384x384" href="icons/icon-384x384.svg" />
  <link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512x512.svg" />
  
  <!-- Splash Screens -->
  <link rel="apple-touch-startup-image" href="icons/icon-512x512.svg" />
  
  <!-- Standard Icons -->
  <link rel="icon" type="image/svg+xml" href="icons/icon-192x192.svg" />
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-128x128.svg" />
  <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-72x72.svg" />
  <link rel="shortcut icon" href="icons/icon-72x72.svg" />
  
  <!-- Microsoft -->
  <meta name="msapplication-TileImage" content="icons/icon-144x144.svg" />
  <meta name="msapplication-config" content="browserconfig.xml" />
  
  <!-- Security -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' ws: wss:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self';" />
  
  <!-- Stylesheets -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="hud-system.css" />
  <link rel="stylesheet" href="ui-settings.css" />
  <link rel="stylesheet" href="ship-editor.css" />
  <link rel="stylesheet" href="trading-ui.css" />
  <link rel="stylesheet" href="faction-ui.css" />
  <link rel="stylesheet" href="skill-system.css" />
  <link rel="stylesheet" href="guild-system.css" />
  <link rel="stylesheet" href="hazard-system.css" />
  <link rel="stylesheet" href="research-system.css" />
  <link rel="stylesheet" href="mobile.css" />
  
  <!-- Preload Critical Resources -->
  <link rel="preload" href="client-enhanced.js" as="script" />
  <link rel="preload" href="mobile-controls.js" as="script" />
  <link rel="dns-prefetch" href="//fonts.googleapis.com" />
</head>
<body>
  <canvas id="game"></canvas>
  
  <!-- Main HUD -->
  <div id="hud">
    <div class="hud-section player-stats">
      <div class="stat-item">
        <span class="stat-label">Resources</span>
        <span id="resources" class="stat-value">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Level</span>
        <span id="level" class="stat-value">1</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Position</span>
        <span id="position" class="stat-value">0, 0</span>
      </div>
    </div>
    
    <div class="hud-section ship-stats">
      <div class="stat-item">
        <span class="stat-label">Speed</span>
        <span id="shipSpeed" class="stat-value">2.0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Cargo</span>
        <span id="shipCargo" class="stat-value">1000</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Range</span>
        <span id="shipRange" class="stat-value">40</span>
      </div>
    </div>
    
    <div class="hud-section combat-stats">
      <div class="stat-item">
        <span class="stat-label">Health</span>
        <span id="shipHealth" class="stat-value">100/100</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Damage</span>
        <span id="shipDamage" class="stat-value">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Weapon Range</span>
        <span id="shipWeaponRange" class="stat-value">0</span>
      </div>
    </div>
    
    <div class="hud-section quick-actions">
      <button id="addEngine" class="action-btn" title="Add Engine Module">
        <span class="btn-icon">‚öô</span>
        <span class="btn-text">Engine (50)</span>
      </button>
      <button id="addCargo" class="action-btn" title="Add Cargo Module">
        <span class="btn-icon">üì¶</span>
        <span class="btn-text">Cargo (30)</span>
      </button>
      <button id="addWeapon" class="action-btn" title="Add Weapon Module">
        <span class="btn-icon">‚öî</span>
        <span class="btn-text">Weapon (70)</span>
      </button>
      <button id="addShield" class="action-btn" title="Add Shield Module">
        <span class="btn-icon">üõ°</span>
        <span class="btn-text">Shield (60)</span>
      </button>
      <button id="addWarpDrive" class="action-btn" title="Add Warp Drive Module">
        <span class="btn-icon">üåÄ</span>
        <span class="btn-text">Warp Drive (150)</span>
      </button>
      <button id="addReactor" class="action-btn" title="Add Reactor Module">
        <span class="btn-icon">‚ö°</span>
        <span class="btn-text">Reactor (120)</span>
      </button>
      <button id="shopToggle" class="action-btn" title="Open Shop">
        <span class="btn-icon">üõí</span>
        <span class="btn-text">Shop</span>
      </button>
      <button id="shipEditorToggle" class="action-btn" title="Open Ship Designer">
        <span class="btn-icon">üîß</span>
        <span class="btn-text">Designer</span>
      </button>
    </div>
    
    <!-- Weapon Cooldown Indicator -->
    <div class="hud-section weapon-status">
      <div class="weapon-cooldown-container">
        <div class="weapon-cooldown-label">Weapon</div>
        <div class="weapon-cooldown-bar">
          <div id="weaponCooldownBar" class="weapon-cooldown-fill"></div>
        </div>
        <div id="selectedTargetName" class="target-name">No Target</div>
      </div>
    </div>
  </div>
  
  <!-- Minimap -->
  <canvas id="minimap"></canvas>
  
  <!-- New HUD System Container -->
  <div class="hud-container">
    
    <!-- HUD Toggle Buttons -->
    <div class="hud-toggles-right hud-toggle-container">
      <div class="hud-toggle-btn" id="factionToggle">
        <span class="hud-toggle-icon">‚öîÔ∏è</span>
        <span class="hud-toggle-label">Factions</span>
        <span class="hud-toggle-badge" id="factionBadge"></span>
      </div>
      <div class="hud-toggle-btn" id="skillsToggle">
        <span class="hud-toggle-icon">üéØ</span>
        <span class="hud-toggle-label">Skills</span>
        <span class="hud-toggle-badge" id="skillsBadge"></span>
      </div>
    </div>
    
    <div class="hud-toggles-left hud-toggle-container">
      <div class="hud-toggle-btn" id="guildToggle">
        <span class="hud-toggle-icon">üõ°Ô∏è</span>
        <span class="hud-toggle-label">Guild</span>
        <span class="hud-toggle-badge" id="guildBadge"></span>
      </div>
    </div>
    
    <div class="hud-toggles-top hud-toggle-container">
      <div class="hud-toggle-btn" id="researchToggle">
        <span class="hud-toggle-icon">üî¨</span>
        <span class="hud-toggle-label">Research</span>
        <span class="hud-toggle-badge" id="researchBadge"></span>
      </div>
    </div>
    
    <div class="hud-toggles-bottom hud-toggle-container">
      <div class="hud-toggle-btn" id="tradingToggle">
        <span class="hud-toggle-icon">üí∞</span>
        <span class="hud-toggle-label">Trading</span>
        <span class="hud-toggle-badge" id="tradingBadge"></span>
      </div>
      <div class="hud-toggle-btn" id="shopToggleNew">
        <span class="hud-toggle-icon">üõí</span>
        <span class="hud-toggle-label">Shop</span>
      </div>
      <div class="hud-toggle-btn" id="shipEditorToggleNew">
        <span class="hud-toggle-icon">üîß</span>
        <span class="hud-toggle-label">Designer</span>
      </div>
    </div>
    
    <!-- HUD Panels -->
    
    <!-- Faction Panel - Right Side -->
    <div class="hud-panel right faction-panel" id="factionHudPanel">
      <div class="hud-panel-header">
        <span class="hud-panel-title">Faction Relations</span>
        <div class="hud-panel-controls">
          <button class="hud-control-btn" id="factionRefresh" title="Refresh">üîÑ</button>
          <button class="hud-control-btn danger" id="factionClose" title="Close">√ó</button>
        </div>
      </div>
      <div class="hud-panel-content hud-scrollbar">
        <div id="factionContent">
          <!-- Faction content will be populated here -->
        </div>
      </div>
    </div>
    
    <!-- Guild Panel - Left Side -->
    <div class="hud-panel left guild-panel" id="guildHudPanel">
      <div class="hud-panel-header">
        <span class="hud-panel-title">Guild Management</span>
        <div class="hud-panel-controls">
          <button class="hud-control-btn" id="guildRefresh" title="Refresh">üîÑ</button>
          <button class="hud-control-btn danger" id="guildClose" title="Close">√ó</button>
        </div>
      </div>
      <div class="hud-panel-content hud-scrollbar">
        <div class="guild-quick-actions">
          <button class="guild-action-btn" id="createGuild">Create</button>
          <button class="guild-action-btn" id="joinGuild">Join</button>
          <button class="guild-action-btn" id="guildHalls">Halls</button>
        </div>
        <div id="guildContent">
          <!-- Guild content will be populated here -->
        </div>
      </div>
    </div>
    
    <!-- Skills Panel - Top Right -->
    <div class="hud-panel right skills-panel" id="skillsHudPanel">
      <div class="hud-panel-header">
        <span class="hud-panel-title">Skill Development</span>
        <div class="hud-panel-controls">
          <button class="hud-control-btn" id="skillsExpand" title="Full View">‚õ∂</button>
          <button class="hud-control-btn danger" id="skillsClose" title="Close">√ó</button>
        </div>
      </div>
      <div class="hud-panel-content hud-scrollbar">
        <div class="skill-tree-compact" id="skillsContent">
          <!-- Skills content will be populated here -->
        </div>
      </div>
    </div>
    
    <!-- Research Panel - Top -->
    <div class="hud-panel top research-panel" id="researchHudPanel">
      <div class="hud-panel-header">
        <span class="hud-panel-title">Research & Technology</span>
        <div class="hud-panel-controls">
          <button class="hud-control-btn" id="researchExpand" title="Full View">‚õ∂</button>
          <button class="hud-control-btn danger" id="researchClose" title="Close">√ó</button>
        </div>
      </div>
      <div class="hud-panel-content hud-scrollbar">
        <div class="research-tabs">
          <button class="research-tab active" data-tab="active">Active</button>
          <button class="research-tab" data-tab="available">Available</button>
          <button class="research-tab" data-tab="completed">Completed</button>
        </div>
        <div id="researchContent">
          <!-- Research content will be populated here -->
        </div>
      </div>
    </div>
    
    <!-- Trading Panel - Bottom -->
    <div class="hud-panel bottom trading-panel" id="tradingHudPanel">
      <div class="hud-panel-header">
        <span class="hud-panel-title">Trading & Commerce</span>
        <div class="hud-panel-controls">
          <button class="hud-control-btn" id="tradingExpand" title="Full View">‚õ∂</button>
          <button class="hud-control-btn danger" id="tradingClose" title="Close">√ó</button>
        </div>
      </div>
      <div class="hud-panel-content hud-scrollbar">
        <div class="trading-tabs">
          <button class="trading-tab active" data-tab="stations">Stations</button>
          <button class="trading-tab" data-tab="market">Market</button>
          <button class="trading-tab" data-tab="contracts">Contracts</button>
        </div>
        <div id="tradingContent">
          <!-- Trading content will be populated here -->
        </div>
      </div>
    </div>
    
    <!-- Shop Panel - Bottom -->
    <div class="hud-panel bottom" id="shopHudPanel">
      <div class="hud-panel-header">
        <span class="hud-panel-title">Space Shop</span>
        <div class="hud-panel-controls">
          <button class="hud-control-btn" id="shopRefresh" title="Refresh">üîÑ</button>
          <button class="hud-control-btn danger" id="shopCloseNew" title="Close">√ó</button>
        </div>
      </div>
      <div class="hud-panel-content hud-scrollbar">
        <div id="shopContent">
          <!-- Shop items will be populated here -->
        </div>
      </div>
    </div>
    
  </div>
  
  <!-- Notification Area -->
  <div id="notifications"></div>
  
  <!-- Combat Log -->
  <div id="combatLogPanel" class="combat-log-panel">
    <div class="combat-log-header">Combat Log</div>
    <div id="combatLog" class="combat-log-content">
      <!-- Combat log entries will be populated here -->
    </div>
  </div>
  
  <!-- Controls Help -->
  <div id="controls" class="help-panel">
    <div class="help-title">Controls</div>
    <div class="help-content">
      <div>WASD / Arrows - Move</div>
      <div>Scroll - Zoom</div>
      <div>Tab - Toggle Shop</div>
      <div>B - Ship Designer</div>
      <div>G - Galaxy Map</div>
      <div>K - Skills</div>
      <div>T - Trading Interface</div>
      <div>M - Market Orders</div>
      <div>C - Contracts</div>
      <div>F - Faction Relations</div>
      <div>U - Guild Management</div>
      <div>R - Research & Technology</div>
      <div>Click - Target Enemy</div>
      <div>Space - Fire Weapon</div>
      <div>Shift+Tab - Cycle Targets</div>
    </div>
  </div>
  
  <!-- Online Players Counter -->
  <div id="onlineStatus">
    <span class="status-indicator"></span>
    <span id="playerCount">0</span> pilots online
  </div>
  
  <script src="hud-controller.js"></script>
  <script src="ui-settings.js"></script>
  <script src="faction-hud-adapter.js"></script>
  <script src="guild-hud-adapter.js"></script>
  <script src="trading-hud-adapter.js"></script>
  <script src="galaxy-ui.js"></script>
  <script src="ship-editor.js"></script>
  <script src="trading-ui.js"></script>
  <script src="faction-ui.js"></script>
  <script src="skill-system.js"></script>
  <script src="guild-system.js"></script>
  <script src="hazard-system.js"></script>
  <script src="research-system.js"></script>
  <script src="mobile-controls.js"></script>
  <script src="push-notifications.js"></script>
  <script src="mobile-performance.js"></script>
  <script src="client-enhanced.js"></script>
  
  <!-- PWA Installation and Setup -->
  <script>
    // PWA Installation handling
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // Show custom install UI
      const installButton = document.createElement('div');
      installButton.className = 'install-prompt';
      installButton.innerHTML = `
        <div class="install-content">
          <h3>Install StarForge Frontier</h3>
          <p>Install the app for the best gaming experience!</p>
          <button onclick="installPWA()">Install</button>
          <button onclick="dismissInstall()">Later</button>
        </div>
      `;
      installButton.style.cssText = `
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        background: linear-gradient(135deg, #0d1421, #1a2332);
        color: white; padding: 20px; border-radius: 12px; z-index: 9999;
        border: 1px solid #64b5f6; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        text-align: center; max-width: 300px; font-family: Arial, sans-serif;
      `;
      document.body.appendChild(installButton);
    });
    
    function installPWA() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('User accepted the install prompt');
          }
          deferredPrompt = null;
          dismissInstall();
        });
      }
    }
    
    function dismissInstall() {
      const prompt = document.querySelector('.install-prompt');
      if (prompt) prompt.remove();
    }
    
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('SW registered: ', registration);
            
            // Handle updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New content available
                  if (confirm('New version available! Reload to update?')) {
                    window.location.reload();
                  }
                }
              });
            });
          })
          .catch((registrationError) => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }
    
    // Handle app shortcuts
    const urlParams = new URLSearchParams(window.location.search);
    const shortcut = urlParams.get('shortcut');
    
    if (shortcut) {
      window.addEventListener('load', () => {
        setTimeout(() => {
          const keyMap = {
            'designer': 'KeyB',
            'galaxy': 'KeyG',
            'trading': 'KeyT'
          };
          
          const key = keyMap[shortcut];
          if (key) {
            const event = new KeyboardEvent('keydown', { code: key });
            window.dispatchEvent(event);
          }
        }, 1000);
      });
    }
    
    // Performance monitoring
    if ('performance' in window) {
      window.addEventListener('load', () => {
        setTimeout(() => {
          const perfData = performance.getEntriesByType('navigation')[0];
          console.log('App load time:', perfData.loadEventEnd - perfData.fetchStart);
          
          // Send performance data to server for optimization
          fetch('/api/performance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              loadTime: perfData.loadEventEnd - perfData.fetchStart,
              domContentLoaded: perfData.domContentLoadedEventEnd - perfData.fetchStart,
              userAgent: navigator.userAgent,
              timestamp: new Date().toISOString()
            })
          }).catch(() => {}); // Ignore errors
        }, 0);
      });
    }
  </script>
</body>
</html>
